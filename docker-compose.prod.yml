# ============================================
# Smart Hospital System - Production Deployment
# 8 Containers: Nginx, Frontend, Auth, Core, IoT, Chat, Medical-ChatBot, MongoDB
# Docker Hub: monabawi/*
# ============================================

services:

  # ==========================================
  # Container 1: API Gateway (Nginx)
  # ==========================================
  nginx:
    image: monabawi/hospital-gateway:v3
    container_name: hospital-gateway
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - auth-service
      - core-service
      - iot-service
      - chat-service
      - medical-chatbot
    networks:
      - hospital-network
    restart: always

  # ==========================================
  # Container 2: Frontend (React + Vite)
  # ==========================================
  frontend:
    image: monabawi/hospital-frontend:v3
    # To rebuild locally with production URLs, uncomment below and comment out image:
    # build:
    #   context: ./frontend
    #   dockerfile: Dockerfile.prod
    container_name: hospital-frontend
    expose:
      - "80"
    networks:
      - hospital-network
    restart: always

  # ==========================================
  # Container 3: Auth Service (Node.js)
  # Handles: Login, Registration, Token Verification
  # ==========================================
  auth-service:
    image: monabawi/hospital-auth-service:v3
    container_name: hospital-auth-service
    expose:
      - "4001"
    environment:
      - PORT=4001
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: always

  # ==========================================
  # Container 4: Core Service (Node.js)
  # Handles: Staff CRUD, Patients CRUD, Doctor-specific endpoints
  # ==========================================
  core-service:
    image: monabawi/hospital-core-service:v3
    container_name: hospital-core-service
    expose:
      - "4002"
    environment:
      - PORT=4002
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: always

  # ==========================================
  # Container 5: IoT Service (Node.js)
  # Handles: Sensor Readings from Medical Devices
  # ==========================================
  iot-service:
    image: monabawi/hospital-iot-service:v3
    container_name: hospital-iot-service
    expose:
      - "4003"
    environment:
      - PORT=4003
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: always

  # ==========================================
  # Container 6: Chat Service (Node.js + Socket.io)
  # Handles: Real-time Messaging, Conversations
  # ==========================================
  chat-service:
    image: monabawi/hospital-chat-service:v3
    container_name: hospital-chat-service
    expose:
      - "4004"
    environment:
      - PORT=4004
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: always

  # ==========================================
  # Container 7: Medical ChatBot Service (Python Flask + LangChain)
  # Handles: RAG-based Medical Assistant using Pinecone & Groq
  # ==========================================
  medical-chatbot:
    image: monabawi/hospital-medical-chatbot:v3
    container_name: hospital-medical-chatbot
    expose:
      - "9090"
    environment:
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    networks:
      - hospital-network
    restart: always

  # ==========================================
  # Container 8: Database (MongoDB)
  # ==========================================
  mongo:
    image: mongo:7
    container_name: hospital-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - hospital-network
    restart: always

# ==========================================
# Shared Network
# ==========================================
networks:
  hospital-network:
    driver: bridge

# ==========================================
# Volumes
# ==========================================
volumes:
  mongo_data:
    driver: local
