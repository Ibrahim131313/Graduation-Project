# ============================================
# Smart Hospital System - LOCAL Development
# HTTP only, no SSL, localhost
# 8 Containers: Nginx, Frontend, Auth, Core, IoT, Chat, Medical-ChatBot, MongoDB
# ============================================

services:

  # ==========================================
  # Container 1: API Gateway (Nginx) - LOCAL HTTP
  # ==========================================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile.local
    container_name: hospital-gateway
    ports:
      - "3000:80"
    depends_on:
      - frontend
      - auth-service
      - core-service
      - iot-service
      - chat-service
      - medical-chatbot
    networks:
      - hospital-network
    restart: unless-stopped

  # ==========================================
  # Container 2: Frontend (React + Vite)
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.microservices
    container_name: hospital-frontend
    expose:
      - "80"
    networks:
      - hospital-network
    restart: unless-stopped

  # ==========================================
  # Container 3: Auth Service (Node.js)
  # Handles: Login, Registration, Token Verification
  # ==========================================
  auth-service:
    build: ./services/auth-service
    container_name: hospital-auth-service
    expose:
      - "4001"
    environment:
      - PORT=4001
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: unless-stopped

  # ==========================================
  # Container 4: Core Service (Node.js)
  # Handles: Staff CRUD, Patients CRUD, Doctor-specific endpoints
  # ==========================================
  core-service:
    build: ./services/core-service
    container_name: hospital-core-service
    expose:
      - "4002"
    environment:
      - PORT=4002
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: unless-stopped

  # ==========================================
  # Container 5: IoT Service (Node.js)
  # Handles: Sensor Readings from Medical Devices
  # ==========================================
  iot-service:
    build: ./services/iot-service
    container_name: hospital-iot-service
    expose:
      - "4003"
    environment:
      - PORT=4003
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: unless-stopped

  # ==========================================
  # Container 6: Chat Service (Node.js + Socket.io)
  # Handles: Real-time Messaging, Conversations
  # ==========================================
  chat-service:
    build: ./services/chat-service
    container_name: hospital-chat-service
    expose:
      - "4004"
    environment:
      - PORT=4004
      - DATABASE_URL=mongodb://mongo:27017/hospital_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - mongo
    networks:
      - hospital-network
    restart: unless-stopped

  # ==========================================
  # Container 7: Medical ChatBot Service (Python Flask + LangChain)
  # Handles: RAG-based Medical Assistant using Pinecone & Groq
  # ==========================================
  medical-chatbot:
    build: ./Medical-ChatBot-main
    container_name: hospital-medical-chatbot
    expose:
      - "9090"
    environment:
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    networks:
      - hospital-network
    restart: unless-stopped

  # ==========================================
  # Container 8: Database (MongoDB)
  # ==========================================
  mongo:
    image: mongo:7
    container_name: hospital-mongodb
    expose:
      - "27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - hospital-network
    restart: unless-stopped

# ==========================================
# Shared Network
# ==========================================
networks:
  hospital-network:
    driver: bridge

# ==========================================
# Volumes
# ==========================================
volumes:
  mongo_data:
    driver: local
